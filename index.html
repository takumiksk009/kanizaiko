<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ä½¿ç”¨æ¸ˆã¿åœ¨åº«ä¸€è¦§</title>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 20px; color: #2c3e50; margin-top: 60px; }
    h1, h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #7f8c8d; color: white; }
    .nav {
      position: fixed; top: 0; left: 0; right: 0; background: #34495e; padding: 10px; text-align: center;
    }
    .nav a {
      margin: 0 10px; color: white; text-decoration: none; font-weight: bold;
    }
    input.price-input {
      width: 100px;
      text-align: right;
    }
    .more-button {
      display: block;
      margin: 5px auto 25px;
      padding: 5px 15px;
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .more-button:hover {
      background: #3498db;
    }
    .edit-controls {
      position: absolute;
      top: 10px;
      right: 10px;
    }
  </style>
</head>
<body>
  <div class="nav">
    <a href="zaiko-toroku.html">ğŸ“… åœ¨åº«ç™»éŒ²</a>
    <a href="inventory-list.html">ğŸ“‹ æœªä½¿ç”¨ä¸€è¦§</a>
    <a href="inventory-used.html">âœ” ä½¿ç”¨æ¸ˆã¿ä¸€è¦§</a>
    <a href="report.html">ğŸ–˜ ä½¿ç”¨å±¥æ­´</a>
    <div class="edit-controls">
      <button id="editToggle">âœ ç·¨é›†</button>
    </div>
  </div>

  <h1>âœ” ä½¿ç”¨æ¸ˆã¿ åœ¨åº«ä¸€è¦§</h1>
  <div id="usedContainer"></div>
  <div style="text-align:center; margin-top: 20px;">
    <button onclick="savePrices()">ğŸ“Œ ç´å…¥ä¾¡æ ¼ã‚’ä¿å­˜</button>
    <button id="deleteButton" style="display:none; margin-left: 10px;" onclick="deleteSelected()">âŒ é¸æŠã—ãŸé …ç›®ã‚’å‰Šé™¤</button>
  </div>

  <script>
    const inventory = JSON.parse(localStorage.getItem('inventoryData') || '[]');
    let usedReports = JSON.parse(localStorage.getItem('usedReports') || '[]');

    const grouped = {};
    usedReports.forEach((report, index) => {
      const item = inventory.find(i => i.id === report.itemId);
      if (!item) return;
      const category = item.category || "æœªåˆ†é¡";
      if (!grouped[category]) grouped[category] = [];

      const usedDateFormatted = report.date ? new Date(report.date).toLocaleDateString('ja-JP', { year: 'numeric', month: 'numeric', day: 'numeric' }) : '';

      grouped[category].push({
        user: item.user,
        site: item.site || "",
        name: item.name,
        model: item.model,
        date: item.date,
        usedBy: report.user || '',
        quantity: report.quantity || '',
        usedDate: usedDateFormatted,
        manageCode: report.manageCode || '',
        price: report.price || "",
        index
      });
    });

    const container = document.getElementById('usedContainer');
    let editMode = false;

    Object.keys(grouped).forEach(category => {
      const heading = document.createElement('h2');
      heading.textContent = `ğŸ“ ${category}`;
      container.appendChild(heading);

      const table = document.createElement('table');
      const tbody = document.createElement('tbody');
      const maxVisible = 10;

      grouped[category].forEach((item, i) => {
        const row = document.createElement('tr');
        if (i >= maxVisible) row.style.display = 'none';
        row.innerHTML = `
          <td>${item.user}</td>
          <td>${item.site}</td>
          <td>${item.name}</td>
          <td>${item.model}</td>
          <td>${item.date}</td>
          <td>${item.usedBy}</td>
          <td>${item.quantity}</td>
          <td>${item.manageCode}</td>
          <td>${item.usedDate}</td>
          <td><input type="text" class="price-input" data-index="${item.index}" value="${item.price}" placeholder="0å††"></td>
          <td class="checkbox-cell" style="display:none;"><input type="checkbox" class="delete-check" data-index="${item.index}"></td>
        `;
        tbody.appendChild(row);
      });

      table.innerHTML = `
        <thead>
          <tr>
            <th>ç™»éŒ²è€…</th>
            <th>ç¾å ´å</th>
            <th>å•†å“å</th>
            <th>å‹å¼</th>
            <th>ä»•å…¥ã‚Œæ—¥</th>
            <th>ä½¿ç”¨è€…</th>
            <th>ä½¿ç”¨æ•°</th>
            <th>ç®¡ç†ç•ªå·</th>
            <th>ä½¿ç”¨æ—¥</th>
            <th>ç´å…¥ä¾¡æ ¼</th>
            <th class="checkbox-cell" style="display:none;">é¸æŠ</th>
          </tr>
        </thead>
      `;
      table.appendChild(tbody);
      container.appendChild(table);

      if (grouped[category].length > maxVisible) {
        const button = document.createElement('button');
        button.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹';
        button.className = 'more-button';
        let expanded = false;

        button.addEventListener('click', () => {
          const rows = tbody.querySelectorAll('tr');
          rows.forEach((row, i) => {
            if (i >= maxVisible) row.style.display = expanded ? 'none' : '';
          });
          expanded = !expanded;
          button.textContent = expanded ? 'é–‰ã˜ã‚‹' : 'ã‚‚ã£ã¨è¦‹ã‚‹';
        });

        container.appendChild(button);
      }
    });

    document.addEventListener('blur', function (e) {
      if (e.target.classList.contains('price-input')) {
        let value = e.target.value.replace(/[^\d]/g, '');
        e.target.value = value ? parseInt(value, 10).toLocaleString() + 'å††' : '';
      }
    }, true);

    function savePrices() {
      const inputs = document.querySelectorAll('.price-input');
      inputs.forEach(input => {
        const index = input.getAttribute('data-index');
        let value = input.value.replace(/[^\d]/g, '');
        usedReports[index].price = value ? parseInt(value, 10).toLocaleString() + 'å††' : '';
      });
      localStorage.setItem('usedReports', JSON.stringify(usedReports));
      alert("ç´å…¥ä¾¡æ ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
    }

    document.getElementById('editToggle').addEventListener('click', () => {
      editMode = !editMode;
      document.querySelectorAll('.checkbox-cell').forEach(cell => {
        cell.style.display = editMode ? '' : 'none';
      });
      document.getElementById('deleteButton').style.display = editMode ? 'inline-block' : 'none';
      document.getElementById('editToggle').textContent = editMode ? 'âœ… å®Œäº†' : 'âœ ç·¨é›†';
    });

    function deleteSelected() {
      const checked = document.querySelectorAll('.delete-check:checked');
      if (!checked.length) return alert("å‰Šé™¤ã™ã‚‹é …ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼");
      if (!confirm("é¸æŠã—ãŸé …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      const indexes = Array.from(checked).map(cb => parseInt(cb.dataset.index));
      usedReports = usedReports.filter((_, i) => !indexes.includes(i));
      localStorage.setItem('usedReports', JSON.stringify(usedReports));
      alert("å‰Šé™¤ã—ã¾ã—ãŸï¼");
      location.reload();
    }
  </script>
</body>
</html>