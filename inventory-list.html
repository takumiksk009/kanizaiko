
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>åœ¨åº«ä¸€è¦§</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<style>
/* çœç•¥ã›ãšã™ã¹ã¦ä¿æŒ */
body { font-family: sans-serif; background: #f9f9f9; padding: 20px; color: #2c3e50; margin-top: 60px; }
h1, h2 { text-align: center; }
table { width: 100%; border-collapse: collapse; margin-bottom: 30px; table-layout: fixed; }
th, td { padding: 12px; border: 1px solid #ccc; text-align: center; vertical-align: middle; font-size: 16px; word-wrap: break-word; }
th { background-color: #3498db; color: white; }
button { padding: 10px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
.unused { background-color: #e67e22; color: white; }
.delete { background-color: #c0392b; color: white; }
.select-group { display: flex; gap: 6px; justify-content: center; align-items: center; flex-wrap: wrap; }
.input-group {
  display: flex; flex-direction: column; align-items: stretch; gap: 6px; width: 100%;
}
.input-group select, .input-group input {
  width: 100%; box-sizing: border-box;
}
.nav {
  position: fixed; top: 0; left: 0; right: 0; background: #34495e; padding: 10px; text-align: center;
}
.nav a {
  margin: 0 10px; color: white; text-decoration: none; font-weight: bold;
}
#editModeButton {
  position: fixed; top: 10px; right: 10px; background: #2c3e50; color: white;
  padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; z-index: 1001;
}
#deleteSelectedBtn {
  display: none; position: fixed; top: 60px; right: 10px; background: #c0392b;
  color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; z-index: 1001;
}
input::placeholder { color: #aaa; font-style: italic; }
select, input[type="text"] {
  padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;
}
.manage-label {
  display: flex; align-items: center; gap: 4px;
}
.manage-label span { font-weight: bold; }
.manage-label input { width: 60px; text-align: center; }
@media (max-width: 600px) {
  th, td { font-size: 14px; padding: 8px; }
  button { font-size: 13px; padding: 8px 12px; }
}
input, select, textarea, button { font-size: 15px !important; }
</style>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
<div class="nav">
<a href="zaiko-toroku.html">ğŸ“¥ åœ¨åº«ç™»éŒ²</a>
<a href="inventory-list.html">ğŸ“‹ æœªä½¿ç”¨ä¸€è¦§</a>
<a href="inventory-used.html">âœ” ä½¿ç”¨æ¸ˆã¿ä¸€è¦§</a>
<a href="report.html">ğŸ“œ ä½¿ç”¨å±¥æ­´</a>
</div>
<button id="editModeButton" onclick="toggleEditMode()">ğŸ›  ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
<button id="deleteSelectedBtn" onclick="deleteSelectedItems()">ğŸ—‘ é¸æŠå‰Šé™¤</button>
<h1>ğŸ“¦ æœªä½¿ç”¨ åœ¨åº«ä¸€è¦§</h1>
<div id="inventoryContainer"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyARhO9hECPxXopKRBZrHBAkboqmCxY651i0",
  authDomain: "zaiko-app-54fa6.firebaseapp.com",
  databaseURL: "https://zaiko-app-54fa6-default-rtdb.firebaseio.com",
  projectId: "zaiko-app-54fa6",
  storageBucket: "zaiko-app-54fa6.appspot.com",
  messagingSenderId: "615970420186",
  appId: "1:615970420186:web:8eab3b94d70da28f5bce3"
};
firebase.initializeApp(firebaseConfig);

const container = document.getElementById("inventoryContainer");
let editMode = false;

function toggleEditMode() {
  editMode = !editMode;
  document.querySelectorAll(".delete-checkbox").forEach(cb => cb.style.display = editMode ? "inline-block" : "none");
  document.getElementById("deleteSelectedBtn").style.display = editMode ? "inline-block" : "none";
  document.getElementById("editModeButton").textContent = editMode ? "âœ… ç·¨é›†çµ‚äº†" : "ğŸ›  ç·¨é›†ãƒ¢ãƒ¼ãƒ‰";
}

function deleteSelectedItems() {
  const checkedBoxes = document.querySelectorAll(".delete-checkbox input:checked");
  if (checkedBoxes.length === 0) {
    alert("å‰Šé™¤ã™ã‚‹åœ¨åº«ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
    return;
  }
  if (!confirm("é¸æŠã•ã‚ŒãŸåœ¨åº«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  checkedBoxes.forEach(cb => {
    firebase.database().ref("inventory/" + cb.value).remove();
  });
  setTimeout(() => loadInventoryFromFirebase(), 1000);
}

function reportUsed(id, selectorId, qtyId, manageId, prefix) {
  const selectedUser = document.getElementById(selectorId).value;
  const selectedQty = parseInt(document.getElementById(qtyId).value);
  const manageCode = document.getElementById(manageId).value.trim();
  if (!selectedUser || !selectedQty) {
    alert("ä½¿ç”¨è€…ã¨å€‹æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  const fullManageCode = prefix + manageCode;
  firebase.database().ref("usedReports").push({
    itemId: id,
    user: selectedUser,
    quantity: selectedQty,
    manageCode: fullManageCode,
    date: new Date().toLocaleString()
  });
  alert(`ä½¿ç”¨è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼š${selectedUser} ãŒ ${selectedQty}å€‹ (${fullManageCode}) ä½¿ç”¨`);
}

function getPrefix(category) {
  if (category.includes("çµ¦æ¹¯å™¨")) return "ã‚­-";
  if (category.includes("æ¹¯æ²¸å™¨")) return "ãƒ¦-";
  if (category.includes("ãƒªãƒ¢ã‚³ãƒ³")) return "ãƒª-";
  return "-";
}

function loadInventoryFromFirebase() {
  firebase.database().ref("inventory").once("value").then(snapshot => {
    const data = snapshot.val();
    container.innerHTML = "";
    if (!data) return;
    const categoryOptions = ["", "ã‚¬ã‚¹çµ¦æ¹¯å™¨", "ã‚¬ã‚¹ç¬é–“æ¹¯æ²¸å™¨", "ãƒªãƒ¢ã‚³ãƒ³", "é…ç®¡ã‚«ãƒãƒ¼"];
    const grouped = {};
    Object.entries(data).forEach(([id, item]) => {
      const cat = item.category || "æœªåˆ†é¡";
      if (!grouped[cat]) grouped[cat] = [];
      grouped[cat].push({ ...item, id });
    });

    Object.keys(grouped).forEach(category => {
      const h2 = document.createElement("h2");
      h2.textContent = `ğŸ“ ${category}`;
      container.appendChild(h2);
      const table = document.createElement("table");
      table.innerHTML = `
        <thead><tr>
          <th>ç™»éŒ²è€…</th><th>ã‚«ãƒ†ã‚´ãƒªï¼†ç¾å ´å</th><th>å•†å“å</th><th>å‹å¼</th>
          <th>å€‹æ•°</th><th>ä»•å…¥æ—¥</th><th>æ“ä½œ</th>
        </tr></thead>
        <tbody>
        ${grouped[category].map(item => {
          const selectorId = `userSelect-${item.id}`;
          const qtyId = `qtySelect-${item.id}`;
          const manageId = `manageId-${item.id}`;
          const prefix = getPrefix(item.category || "");
          return `
            <tr>
              <td>${item.user}</td>
              <td><div class="input-group"><select><option>${item.category}</option></select><input type="text" value="${item.site || ''}" /></div></td>
              <td>${item.name || item.maker}</td>
              <td>${item.model}</td>
              <td>${item.qty}</td>
              <td>${item.date}</td>
              <td>
                <div class="select-group">
                  <select id="${selectorId}"><option value="">ä½¿ç”¨è€…é¸æŠ</option><option value="é˜¿éƒ¨">é˜¿éƒ¨</option><option value="éˆ´æœ¨">éˆ´æœ¨</option></select>
                  <select id="${qtyId}">${[...Array(item.qty).keys()].map(i => `<option value="${i+1}">${i+1}</option>`).join('')}</select>
                  <label class="manage-label"><span>${prefix}</span><input type="text" id="${manageId}" placeholder="ç•ªå·" /></label>
                  <button class="unused" onclick="reportUsed('${item.id}', '${selectorId}', '${qtyId}', '${manageId}', '${prefix}')">ä½¿ç”¨ã™ã‚‹</button>
                  <span class="delete-checkbox" style="display:none"><input type="checkbox" value="${item.id}"></span>
                </div>
              </td>
            </tr>
          `;
        }).join('')}
        </tbody>`;
      container.appendChild(table);
    });
  });
}

window.addEventListener("DOMContentLoaded", loadInventoryFromFirebase);
</script>
</body>
</html>
