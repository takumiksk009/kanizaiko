<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>在庫一覧</title>
<style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 20px; color: #2c3e50; margin-top: 60px; }
    h1, h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 30px; table-layout: fixed; }
    th, td { padding: 12px; border: 1px solid #ccc; text-align: center; vertical-align: middle; font-size: 16px; word-wrap: break-word; }
    th { background-color: #3498db; color: white; }
    button { padding: 10px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .unused { background-color: #e67e22; color: white; }
    .delete { background-color: #c0392b; color: white; }
    .select-group { display: flex; gap: 6px; justify-content: center; align-items: center; flex-wrap: wrap; }
    .input-group {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
      width: 100%;
    }
    .input-group select,
    .input-group input {
      width: 100%;
      box-sizing: border-box;
    }
    .nav {
      position: fixed; top: 0; left: 0; right: 0; background: #34495e; padding: 10px; text-align: center;
    }
    .nav a {
      margin: 0 10px; color: white; text-decoration: none; font-weight: bold;
    }
    #editModeButton {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #2c3e50;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      z-index: 1001;
    }
    #deleteSelectedBtn {
      display: none;
      position: fixed;
      top: 60px;
      right: 10px;
      background: #c0392b;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      z-index: 1001;
    }
    input::placeholder { color: #aaa; font-style: italic; }
    select, input[type="text"] {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .manage-label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .manage-label span {
      font-weight: bold;
    }
    .manage-label input {
      width: 60px;
      text-align: center;
    }
    @media (max-width: 600px) {
      th, td { font-size: 14px; padding: 8px; }
      button { font-size: 13px; padding: 8px 12px; }
    }
  </style>
<!-- Firebase SDK -->



</head>
<body>
<div class="nav">
<a href="zaiko-toroku.html">📥 在庫登録</a>
<a href="inventory-list.html">📋 未使用一覧</a>
<a href="inventory-used.html">✔ 使用済み一覧</a>
<a href="report.html">📜 使用履歴</a>
</div>
<button id="editModeButton" onclick="toggleEditMode()">🛠 編集モード</button>
<button id="deleteSelectedBtn" onclick="deleteSelectedItems()">🗑 選択削除</button>
<h1>📦 未使用 在庫一覧</h1>
<div id="inventoryContainer"></div>


<script>
let inventory = [];

function updateCategory(itemId, newCategory) {
  const item = inventory.find(i => i.id === itemId);
  if (item) {
    item.category = newCategory;
    firebase.database().ref("inventory/" + itemId).update({ category: newCategory });
  }
}

function updateSite(itemId, newSite) {
  const item = inventory.find(i => i.id === itemId);
  if (item) {
    item.site = newSite;
    firebase.database().ref("inventory/" + itemId).update({ site: newSite });
  }
}

function reportUsed(itemId) {
  const usedReports = JSON.parse(localStorage.getItem("usedReports") || "{}");
  if (!usedReports[itemId]) usedReports[itemId] = 0;
  usedReports[itemId]++;
  localStorage.setItem("usedReports", JSON.stringify(usedReports));
  renderInventory();
}

function renderInventory() {
  const usedReports = JSON.parse(localStorage.getItem("usedReports") || "{}");
  const container = document.getElementById("inventoryContainer");
  if (!container) return;
  container.innerHTML = "";

  const categories = {};
  inventory.forEach(item => {
    const category = item.category || "未分類";
    if (!categories[category]) categories[category] = [];
    const used = usedReports[item.id] || 0;
    const remaining = (item.qty || 0) - used;
    if (remaining > 0) categories[category].push({ ...item, used, remaining });
  });

  Object.entries(categories).forEach(([category, items]) => {
    const table = document.createElement("table");
    const caption = document.createElement("caption");
    caption.textContent = category;
    table.appendChild(caption);

    const header = document.createElement("tr");
    ["登録者", "メーカー", "カテゴリ", "型式", "個数", "現場名", "注文日", "残数", "操作"].forEach(text => {
      const th = document.createElement("th");
      th.textContent = text;
      header.appendChild(th);
    });
    table.appendChild(header);

    items.forEach(item => {
      const row = document.createElement("tr");
      [
        item.user, item.maker, item.category, item.model, item.qty, item.site, item.date,
        item.remaining
      ].forEach(value => {
        const td = document.createElement("td");
        td.textContent = value;
        row.appendChild(td);
      });

      const actionTd = document.createElement("td");
      const useBtn = document.createElement("button");
      useBtn.textContent = "使用する";
      useBtn.onclick = () => reportUsed(item.id);
      actionTd.appendChild(useBtn);
      row.appendChild(actionTd);

      table.appendChild(row);
    });

    container.appendChild(table);
  });
}

document.addEventListener("DOMContentLoaded", async () => {
  try {
    const snapshot = await firebase.database().ref("inventory").once("value");
    const data = snapshot.val() || {};
    inventory = Object.entries(data).map(([id, item]) => ({ ...item, id }));
    renderInventory();
  } catch (error) {
    console.error("データの取得に失敗しました:", error);
  }
});
</script>
</body>
</html>