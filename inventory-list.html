<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>åœ¨åº«ä¸€è¦§</title>
<style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 20px; color: #2c3e50; margin-top: 60px; }
    h1, h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 30px; table-layout: fixed; }
    th, td { padding: 12px; border: 1px solid #ccc; text-align: center; vertical-align: middle; font-size: 16px; word-wrap: break-word; }
    th { background-color: #3498db; color: white; }
    button { padding: 10px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .unused { background-color: #e67e22; color: white; }
    .delete { background-color: #c0392b; color: white; }
    .select-group { display: flex; gap: 6px; justify-content: center; align-items: center; flex-wrap: wrap; }
    .input-group {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
      width: 100%;
    }
    .input-group select,
    .input-group input {
      width: 100%;
      box-sizing: border-box;
    }
    .nav {
      position: fixed; top: 0; left: 0; right: 0; background: #34495e; padding: 10px; text-align: center;
    }
    .nav a {
      margin: 0 10px; color: white; text-decoration: none; font-weight: bold;
    }
    #editModeButton {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #2c3e50;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      z-index: 1001;
    }
    #deleteSelectedBtn {
      display: none;
      position: fixed;
      top: 60px;
      right: 10px;
      background: #c0392b;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      z-index: 1001;
    }
    input::placeholder { color: #aaa; font-style: italic; }
    select, input[type="text"] {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .manage-label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .manage-label span {
      font-weight: bold;
    }
    .manage-label input {
      width: 60px;
      text-align: center;
    }
    @media (max-width: 600px) {
      th, td { font-size: 14px; padding: 8px; }
      button { font-size: 13px; padding: 8px 12px; }
    }
  </style>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyARhO9hECPxXopKRBZrHBAkboqmCxY651i0",
    authDomain: "zaiko-app-54fa6.firebaseapp.com",
    databaseURL: "https://zaiko-app-54fa6-default-rtdb.firebaseio.com",
    projectId: "zaiko-app-54fa6",
    storageBucket: "zaiko-app-54fa6.appspot.com",
    messagingSenderId: "615970420186",
    appId: "1:615970420186:web:8eab3b94d70da28f5bce3"
  };
  firebase.initializeApp(firebaseConfig);

  function loadInventoryFromFirebase() {
    firebase.database().ref("inventory").once("value").then(snapshot => {
      const data = snapshot.val();
      const tableBody = document.getElementById("inventory-body");
      tableBody.innerHTML = "";
      if (!data) return;
      Object.entries(data).forEach(([key, item]) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="checkbox" class="select-checkbox" data-id="${key}"></td>
          <td>${item.user || ""}</td>
          <td>${item.name || item.maker || ""}</td>
          <td>${item.category || ""}</td>
          <td>${item.site || ""}</td>
          <td>${item.model || ""}</td>
          <td>${item.qty || 0}</td>
          <td>${item.date || ""}</td>
        `;
        tableBody.appendChild(row);
      });
    });
  }

  window.addEventListener("DOMContentLoaded", () => {
    loadInventoryFromFirebase();
  });
</script>
</head>
<body>
<div class="nav">
<a href="zaiko-toroku.html">ğŸ“¥ åœ¨åº«ç™»éŒ²</a>
<a href="inventory-list.html">ğŸ“‹ æœªä½¿ç”¨ä¸€è¦§</a>
<a href="inventory-used.html">âœ” ä½¿ç”¨æ¸ˆã¿ä¸€è¦§</a>
<a href="report.html">ğŸ“œ ä½¿ç”¨å±¥æ­´</a>
</div>
<button id="editModeButton" onclick="toggleEditMode()">ğŸ›  ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
<button id="deleteSelectedBtn" onclick="deleteSelectedItems()">ğŸ—‘ é¸æŠå‰Šé™¤</button>
<h1>ğŸ“¦ æœªä½¿ç”¨ åœ¨åº«ä¸€è¦§</h1>
<div id="inventoryContainer"></div>
<script>
    const container = document.getElementById('inventoryContainer');
    let inventory = JSON.parse(localStorage.getItem('inventoryData') || '[]');
    const usedReports = JSON.parse(localStorage.getItem('usedReports') || '[]');

    let editMode = false;
    function toggleEditMode() {
      editMode = !editMode;
      document.querySelectorAll('.delete-checkbox').forEach(cb => cb.style.display = editMode ? 'inline-block' : 'none');
      document.getElementById('deleteSelectedBtn').style.display = editMode ? 'inline-block' : 'none';
      document.getElementById('editModeButton').textContent = editMode ? 'âœ… ç·¨é›†çµ‚äº†' : 'ğŸ›  ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
    }

    function deleteSelectedItems() {
      const checkedBoxes = document.querySelectorAll('.delete-checkbox input:checked');
      if (checkedBoxes.length === 0) {
        alert("å‰Šé™¤ã™ã‚‹åœ¨åº«ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
        return;
      }
      if (!confirm("é¸æŠã•ã‚ŒãŸåœ¨åº«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

      const idsToDelete = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
      inventory = inventory.filter(i => !idsToDelete.includes(i.id));
      
      
    }

    
    usedReports.forEach(r => {
      if (!usedMap[r.itemId]) usedMap[r.itemId] = 0;
      usedMap[r.itemId] += parseInt(r.quantity);
    });

    const remainingItems = inventory.map(item => {
      const used = usedMap[item.id] || 0;
      const remaining = item.quantity - used;
      return { ...item, remaining };
    }).filter(item => item.remaining > 0);

    const categoryOptions = ["", "ã‚¬ã‚¹çµ¦æ¹¯å™¨", "ã‚¬ã‚¹ç¬é–“æ¹¯æ²¸å™¨", "ãƒªãƒ¢ã‚³ãƒ³", "é…ç®¡ã‚«ãƒãƒ¼"];

    const grouped = {};
    remainingItems.forEach(item => {
      const cat = item.category || "æœªåˆ†é¡";
      if (!grouped[cat]) grouped[cat] = [];
      grouped[cat].push(item);
    });

    function getPrefix(category) {
      if (category.includes("çµ¦æ¹¯å™¨")) return "ã‚­-";
      if (category.includes("æ¹¯æ²¸")) return "ãƒ¦-";
      if (category.includes("ãƒªãƒ¢ã‚³ãƒ³")) return "ãƒª-";
      return "-";
    }

    

    function reportUsed(id, selectorId, qtyId, manageId, prefix) {
      const selectedUser = document.getElementById(selectorId).value;
      const selectedQty = parseInt(document.getElementById(qtyId).value);
      const manageCode = document.getElementById(manageId).value.trim();

      if (!selectedUser || !selectedQty) {
        alert("ä½¿ç”¨è€…ã¨å€‹æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const fullManageCode = prefix + manageCode;
      const item = inventory.find(i => i.id === id);
      const usedLogs = JSON.parse(localStorage.getItem('usedReports') || '[]');
      usedLogs.push({
        itemId: id,
        itemName: item.name,
        model: item.model,
        user: selectedUser,
        quantity: selectedQty,
        manageCode: fullManageCode,
        date: new Date().toLocaleString()
      });
      
      alert(`ã€Œ${item.name}ã€ã‚’ ${selectedQty} å€‹ï¼ˆ${fullManageCode}ï¼‰ã€${selectedUser} ã•ã‚“ãŒä½¿ç”¨ã—ã¾ã—ãŸï¼`);
      
    }

    function updateCategory(id, newCategory) {
      inventory = inventory.map(i => i.id === id ? { ...i, category: newCategory } : i);
      
      
    }

    function updateSite(id, newSite) {
      inventory = inventory.map(i => i.id === id ? { ...i, site: newSite } : i);
      
    }
  </script>
<div id="inventory-container"></div>
<script>
firebase.database().ref("inventory").once("value").then(snapshot => {
  const data = snapshot.val();
  const container = document.getElementById("inventoryContainer");
  container.innerHTML = "";

  if (!data) return;

  const items = Object.values(data).filter(item => item.used !== true);
  const grouped = {};

  items.forEach(item => {
    if (!grouped[item.category]) grouped[item.category] = [];
    grouped[item.category].push(item);
  });

  Object.keys(grouped).forEach(category => {
    const section = document.createElement("div");
    section.classList.add("category-block");

    const heading = document.createElement("h2");
    heading.textContent = category;
    section.appendChild(heading);

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr>
        <th>ç¾å ´å</th>
        <th>å•†å“å</th>
        <th>å‹å¼</th>
        <th>å€‹æ•°</th>
        <th>ä»•å…¥æ—¥</th>
        <th>ç™»éŒ²è€…</th>
      </tr>`;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    grouped[category].forEach(item => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${item.site || ""}</td>
        <td>${item.name || ""}</td>
        <td>${item.model || ""}</td>
        <td>${item.qty || ""}</td>
        <td>${item.date || ""}</td>
        <td>${item.user || ""}</td>`;
      tbody.appendChild(row);
    });

    table.appendChild(tbody);
    section.appendChild(table);
    container.appendChild(section);
  });
});
</script>

</body>
</html>