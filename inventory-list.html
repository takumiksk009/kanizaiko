
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>在庫一覧</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<style>
/* 省略せずすべて保持 */
body { font-family: sans-serif; background: #f9f9f9; padding: 20px; color: #2c3e50; margin-top: 60px; }
h1, h2 { text-align: center; }
table { width: 100%; border-collapse: collapse; margin-bottom: 30px; table-layout: fixed; }
th, td { padding: 12px; border: 1px solid #ccc; text-align: center; vertical-align: middle; font-size: 16px; word-wrap: break-word; }
th { background-color: #3498db; color: white; }
button { padding: 10px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
.unused { background-color: #e67e22; color: white; }
.delete { background-color: #c0392b; color: white; }
.select-group { display: flex; gap: 6px; justify-content: center; align-items: center; flex-wrap: wrap; }
.input-group {
  display: flex; flex-direction: column; align-items: stretch; gap: 6px; width: 100%;
}
.input-group select, .input-group input {
  width: 100%; box-sizing: border-box;
}
.nav {
  position: fixed; top: 0; left: 0; right: 0; background: #34495e; padding: 10px; text-align: center;
}
.nav a {
  margin: 0 10px; color: white; text-decoration: none; font-weight: bold;
}
#editModeButton {
  position: fixed; top: 10px; right: 10px; background: #2c3e50; color: white;
  padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; z-index: 1001;
}
#deleteSelectedBtn {
  display: none; position: fixed; top: 60px; right: 10px; background: #c0392b;
  color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; z-index: 1001;
}
input::placeholder { color: #aaa; font-style: italic; }
select, input[type="text"] {
  padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;
}
.manage-label {
  display: flex; align-items: center; gap: 4px;
}
.manage-label span { font-weight: bold; }
.manage-label input { width: 60px; text-align: center; }
@media (max-width: 600px) {
  th, td { font-size: 14px; padding: 8px; }
  button { font-size: 13px; padding: 8px 12px; }
}
input, select, textarea, button { font-size: 15px !important; }
</style>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
<div class="nav">
<a href="zaiko-toroku.html">📥 在庫登録</a>
<a href="inventory-list.html">📋 未使用一覧</a>
<a href="inventory-used.html">✔ 使用済み一覧</a>
<a href="report.html">📜 使用履歴</a>
</div>
<button id="editModeButton" onclick="toggleEditMode()">🛠 編集モード</button>
<button id="deleteSelectedBtn" onclick="deleteSelectedItems()">🗑 選択削除</button>
<h1>📦 未使用 在庫一覧</h1>
<div id="inventoryContainer"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyARhO9hECPxXopKRBZrHBAkboqmCxY651i0",
  authDomain: "zaiko-app-54fa6.firebaseapp.com",
  databaseURL: "https://zaiko-app-54fa6-default-rtdb.firebaseio.com",
  projectId: "zaiko-app-54fa6",
  storageBucket: "zaiko-app-54fa6.appspot.com",
  messagingSenderId: "615970420186",
  appId: "1:615970420186:web:8eab3b94d70da28f5bce3"
};
firebase.initializeApp(firebaseConfig);

const container = document.getElementById("inventoryContainer");
let editMode = false;

function toggleEditMode() {
  editMode = !editMode;
  document.querySelectorAll(".delete-checkbox").forEach(cb => cb.style.display = editMode ? "inline-block" : "none");
  document.getElementById("deleteSelectedBtn").style.display = editMode ? "inline-block" : "none";
  document.getElementById("editModeButton").textContent = editMode ? "✅ 編集終了" : "🛠 編集モード";
}

function deleteSelectedItems() {
  const checkedBoxes = document.querySelectorAll(".delete-checkbox input:checked");
  if (checkedBoxes.length === 0) {
    alert("削除する在庫を選んでください。");
    return;
  }
  if (!confirm("選択された在庫を削除しますか？")) return;

  checkedBoxes.forEach(cb => {
    firebase.database().ref("inventory/" + cb.value).remove();
  });
  setTimeout(() => loadInventoryFromFirebase(), 1000);
}

function reportUsed(id, selectorId, qtyId, manageId, prefix) {
  const selectedUser = document.getElementById(selectorId).value;
  const selectedQty = parseInt(document.getElementById(qtyId).value);
  const manageCode = document.getElementById(manageId).value.trim();
  if (!selectedUser || !selectedQty) {
    alert("使用者と個数を選択してください。");
    return;
  }
  const fullManageCode = prefix + manageCode;
  firebase.database().ref("usedReports").push({
    itemId: id,
    user: selectedUser,
    quantity: selectedQty,
    manageCode: fullManageCode,
    date: new Date().toLocaleString()
  });
  alert(`使用記録を保存しました：${selectedUser} が ${selectedQty}個 (${fullManageCode}) 使用`);
}

function getPrefix(category) {
  if (category.includes("給湯器")) return "キ-";
  if (category.includes("湯沸器")) return "ユ-";
  if (category.includes("リモコン")) return "リ-";
  return "-";
}

function loadInventoryFromFirebase() {
  firebase.database().ref("inventory").once("value").then(snapshot => {
    const data = snapshot.val();
    container.innerHTML = "";
    if (!data) return;
    const categoryOptions = ["", "ガス給湯器", "ガス瞬間湯沸器", "リモコン", "配管カバー"];
    const grouped = {};
    Object.entries(data).forEach(([id, item]) => {
      const cat = item.category || "未分類";
      if (!grouped[cat]) grouped[cat] = [];
      grouped[cat].push({ ...item, id });
    });

    Object.keys(grouped).forEach(category => {
      const h2 = document.createElement("h2");
      h2.textContent = `📁 ${category}`;
      container.appendChild(h2);
      const table = document.createElement("table");
      table.innerHTML = `
        <thead><tr>
          <th>登録者</th><th>カテゴリ＆現場名</th><th>商品名</th><th>型式</th>
          <th>個数</th><th>仕入日</th><th>操作</th>
        </tr></thead>
        <tbody>
        ${grouped[category].map(item => {
          const selectorId = `userSelect-${item.id}`;
          const qtyId = `qtySelect-${item.id}`;
          const manageId = `manageId-${item.id}`;
          const prefix = getPrefix(item.category || "");
          return `
            <tr>
              <td>${item.user}</td>
              <td><div class="input-group"><select><option>${item.category}</option></select><input type="text" value="${item.site || ''}" /></div></td>
              <td>${item.name || item.maker}</td>
              <td>${item.model}</td>
              <td>${item.qty}</td>
              <td>${item.date}</td>
              <td>
                <div class="select-group">
                  <select id="${selectorId}"><option value="">使用者選択</option><option value="阿部">阿部</option><option value="鈴木">鈴木</option></select>
                  <select id="${qtyId}">${[...Array(item.qty).keys()].map(i => `<option value="${i+1}">${i+1}</option>`).join('')}</select>
                  <label class="manage-label"><span>${prefix}</span><input type="text" id="${manageId}" placeholder="番号" /></label>
                  <button class="unused" onclick="reportUsed('${item.id}', '${selectorId}', '${qtyId}', '${manageId}', '${prefix}')">使用する</button>
                  <span class="delete-checkbox" style="display:none"><input type="checkbox" value="${item.id}"></span>
                </div>
              </td>
            </tr>
          `;
        }).join('')}
        </tbody>`;
      container.appendChild(table);
    });
  });
}

window.addEventListener("DOMContentLoaded", loadInventoryFromFirebase);
</script>
</body>
</html>
