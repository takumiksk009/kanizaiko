<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>在庫一覧</title>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 20px; color: #2c3e50; margin-top: 60px; }
    h1, h2 { text-align: center; }
    .table-wrapper { overflow-x: auto; }
    table { min-width: 800px; border-collapse: collapse; margin-bottom: 30px; width: 100%; table-layout: fixed; }
    th, td { padding: 12px; border: 1px solid #ccc; text-align: center; font-size: 16px; word-wrap: break-word; }
    th { background-color: #3498db; color: white; }
    button { padding: 10px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .unused { background-color: #e67e22; color: white; }
    .delete { background-color: #c0392b; color: white; }
    .input-group select, .input-group input { width: 100%; padding: 8px; font-size: 14px; box-sizing: border-box; }
    .select-group { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; }
    .nav { position: fixed; top: 0; left: 0; right: 0; background: #34495e; padding: 10px; text-align: center; }
    .nav a { margin: 0 10px; color: white; text-decoration: none; font-weight: bold; }
    #editModeButton, #deleteSelectedBtn {
      position: fixed; top: 10px; right: 10px; background: #2c3e50; color: white; padding: 8px 16px; border-radius: 6px;
      font-size: 14px; cursor: pointer; z-index: 1001;
    }
    #deleteSelectedBtn { top: 60px; background: #c0392b; display: none; }
    @media (max-width: 600px) {
      th, td { font-size: 14px; padding: 8px; }
      button { font-size: 13px; padding: 8px 12px; }
    }
  </style>
</head>
<body>
  <div class="nav">
    <a href="zaiko-toroku.html">📥 在庫登録</a>
    <a href="inventory-list.html">📋 未使用一覧</a>
    <a href="inventory-used.html">✔ 使用済み一覧</a>
    <a href="report.html">📜 使用履歴</a>
  </div>

  <button id="editModeButton" onclick="toggleEditMode()">🛠 編集モード</button>
  <button id="deleteSelectedBtn" onclick="deleteSelectedItems()">🗑 選択削除</button>

  <h1>📦 未使用 在庫一覧</h1>
  <div id="inventoryContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update, get, child, set } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyARhO9hECPxXopKRBZrHBAkboqmCxY651i0",
      authDomain: "zaiko-app-54fa6.firebaseapp.com",
      databaseURL: "https://zaiko-app-54fa6-default-rtdb.firebaseio.com",
      projectId: "zaiko-app-54fa6",
      storageBucket: "zaiko-app-54fa6.appspot.com",
      messagingSenderId: "615970420186",
      appId: "1:615970420186:web:8eab3b94d70da28f5bce3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let editMode = false;
    const container = document.getElementById('inventoryContainer');

    function toggleEditMode() {
      editMode = !editMode;
      document.querySelectorAll('.delete-checkbox').forEach(cb => cb.style.display = editMode ? 'inline-block' : 'none');
      document.getElementById('deleteSelectedBtn').style.display = editMode ? 'inline-block' : 'none';
      document.getElementById('editModeButton').textContent = editMode ? '✅ 編集終了' : '🛠 編集モード';
    }

    async function deleteSelectedItems() {
      const checked = document.querySelectorAll('.delete-checkbox input:checked');
      if (!checked.length) return alert('削除する在庫を選んでください。');
      if (!confirm('選択された在庫をFirebaseから削除しますか？')) return;
      for (const cb of checked) {
        await remove(ref(db, `inventory/${cb.value}`));
      }
      alert("削除しました！");
      location.reload();
    }

    async function loadInventory() {
      const inventorySnap = await get(ref(db, 'inventory'));
      const usedSnap = await get(ref(db, 'usedReports'));

      const inventory = inventorySnap.val() || {};
      const used = usedSnap.val() || {};

      const usedMap = {};
      const usedCodes = new Set();

      Object.values(used).forEach(item => {
        if (!usedMap[item.itemId]) usedMap[item.itemId] = 0;
        usedMap[item.itemId] += Number(item.quantity);
        usedCodes.add(item.manageCode);
      });

      const items = Object.entries(inventory).map(([id, item]) => {
        const remaining = item.quantity - (usedMap[id] || 0);
        return remaining > 0 ? { ...item, id, remaining } : null;
      }).filter(Boolean);

      renderInventory(items, usedCodes);
    }

    function renderInventory(items, usedCodes) {
      const grouped = {};
      const container = document.getElementById('inventoryContainer');
      container.innerHTML = '';

      items.forEach(item => {
        const cat = item.category || '未分類';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(item);
      });

      const categories = Object.keys(grouped);
      const categoryOptions = ["", "ガス給湯器", "ガス瞬間湯沸器", "リモコン", "配管カバー"];

      categories.forEach(cat => {
        const h2 = document.createElement('h2');
        h2.textContent = `📁 ${cat}`;
        container.appendChild(h2);

        const wrapper = document.createElement("div");
        wrapper.className = "table-wrapper";
        const table = document.createElement("table");

        const prefix = cat.includes('給湯') ? 'キ-' : cat.includes('湯沸') ? 'ユ-' : cat.includes('リモコン') ? 'リ-' : '-';

        table.innerHTML = `
          <thead><tr>
            <th>登録者</th><th>カテゴリ＆現場名</th><th>商品名</th><th>型式</th><th>残数</th><th>仕入れ日</th><th>操作</th>
          </tr></thead>
          <tbody>
            ${grouped[cat].map(item => {
              const catSel = categoryOptions.map(opt => `<option value="${opt}" ${opt === item.category ? 'selected' : ''}>${opt}</option>`).join('');
              const qtySel = Array.from({length: item.remaining}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('');
              return `
              <tr>
                <td>${item.user}</td>
                <td>
                  <div class="input-group">
                    <select onchange="updateCategory('${item.id}', this.value)">${catSel}</select>
                    <input type="text" value="${item.site || ''}" onchange="updateSite('${item.id}', this.value)">
                  </div>
                </td>
                <td>${item.name}</td>
                <td>${item.model}</td>
                <td>${item.remaining}</td>
                <td>${item.date}</td>
                <td>
                  <div class="select-group">
                    <select id="user-${item.id}"><option value="">使用者選択</option><option>阿部</option><option>鈴木</option><option>紺野</option><option>亀岡</option><option>大槻</option><option>青田</option><option>菊田</option><option>高橋</option><option>佐藤</option><option>今泉</option></select>
                    <select id="qty-${item.id}">${qtySel}</select>
                    <input type="text" id="code-${item.id}" placeholder="${prefix}番号">
                    <button class="unused" onclick="useItem('${item.id}', '${prefix}', ${JSON.stringify(Array.from(usedCodes))})">使用する</button>
                    <span class="delete-checkbox" style="display:none"><input type="checkbox" value="${item.id}"></span>
                  </div>
                </td>
              </tr>`;
            }).join('')}
          </tbody>`;
        wrapper.appendChild(table);
        container.appendChild(wrapper);
      });
    }

    window.updateCategory = async (id, value) => {
      await update(ref(db, `inventory/${id}`), { category: value });
    }

    window.updateSite = async (id, value) => {
      await update(ref(db, `inventory/${id}`), { site: value });
    }

    window.useItem = async (id, prefix, usedCodes) => {
      const user = document.getElementById(`user-${id}`).value;
      const qty = parseInt(document.getElementById(`qty-${id}`).value);
      const code = document.getElementById(`code-${id}`).value.trim();
      if (!user || !qty || !code) return alert('全項目を入力してね');
      const fullCode = prefix + code;
      if (usedCodes.includes(fullCode)) return alert('その管理番号はすでに使われています！');

      const snap = await get(ref(db, `inventory/${id}`));
      if (!snap.exists()) return alert("在庫が見つかりません");
      const item = snap.val();

      await push(ref(db, "usedReports"), {
        itemId: id,
        itemName: item.name,
        model: item.model,
        user,
        quantity: qty,
        manageCode: fullCode,
        date: new Date().toLocaleString()
      });

      alert(`「${item.name}」を ${qty} 個（${fullCode}）、${user} さんが使用しました！`);
      location.reload();
    }

    loadInventory();
  </script>
</body>
</html>
