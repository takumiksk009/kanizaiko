<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ¨åº«ä¸€è¦§</title>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 20px; color: #2c3e50; margin-top: 60px; }
    h1, h2 { text-align: center; }
    .table-wrapper { overflow-x: auto; }
    table { min-width: 800px; border-collapse: collapse; margin-bottom: 30px; width: 100%; table-layout: fixed; }
    th, td { padding: 12px; border: 1px solid #ccc; text-align: center; font-size: 16px; word-wrap: break-word; }
    th { background-color: #3498db; color: white; }
    button { padding: 10px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .unused { background-color: #e67e22; color: white; }
    .delete { background-color: #c0392b; color: white; }
    .input-group select, .input-group input { width: 100%; padding: 8px; font-size: 14px; box-sizing: border-box; }
    .select-group { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; }
    .nav { position: fixed; top: 0; left: 0; right: 0; background: #34495e; padding: 10px; text-align: center; }
    .nav a { margin: 0 10px; color: white; text-decoration: none; font-weight: bold; }
    #editModeButton, #deleteSelectedBtn {
      position: fixed; top: 10px; right: 10px; background: #2c3e50; color: white; padding: 8px 16px; border-radius: 6px;
      font-size: 14px; cursor: pointer; z-index: 1001;
    }
    #deleteSelectedBtn { top: 60px; background: #c0392b; display: none; }
    @media (max-width: 600px) {
      th, td { font-size: 14px; padding: 8px; }
      button { font-size: 13px; padding: 8px 12px; }
    }
  </style>
</head>
<body>
  <div class="nav">
    <a href="zaiko-toroku.html">ğŸ“¥ åœ¨åº«ç™»éŒ²</a>
    <a href="inventory-list.html">ğŸ“‹ æœªä½¿ç”¨ä¸€è¦§</a>
    <a href="inventory-used.html">âœ” ä½¿ç”¨æ¸ˆã¿ä¸€è¦§</a>
    <a href="report.html">ğŸ“œ ä½¿ç”¨å±¥æ­´</a>
  </div>

  <button id="editModeButton" onclick="toggleEditMode()">ğŸ›  ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
  <button id="deleteSelectedBtn" onclick="deleteSelectedItems()">ğŸ—‘ é¸æŠå‰Šé™¤</button>

  <h1>ğŸ“¦ æœªä½¿ç”¨ åœ¨åº«ä¸€è¦§</h1>
  <div id="inventoryContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update, get, child, set } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyARhO9hECPxXopKRBZrHBAkboqmCxY651i0",
      authDomain: "zaiko-app-54fa6.firebaseapp.com",
      databaseURL: "https://zaiko-app-54fa6-default-rtdb.firebaseio.com",
      projectId: "zaiko-app-54fa6",
      storageBucket: "zaiko-app-54fa6.appspot.com",
      messagingSenderId: "615970420186",
      appId: "1:615970420186:web:8eab3b94d70da28f5bce3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let editMode = false;
    const container = document.getElementById('inventoryContainer');

    function toggleEditMode() {
      editMode = !editMode;
      document.querySelectorAll('.delete-checkbox').forEach(cb => cb.style.display = editMode ? 'inline-block' : 'none');
      document.getElementById('deleteSelectedBtn').style.display = editMode ? 'inline-block' : 'none';
      document.getElementById('editModeButton').textContent = editMode ? 'âœ… ç·¨é›†çµ‚äº†' : 'ğŸ›  ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
    }

    async function deleteSelectedItems() {
      const checked = document.querySelectorAll('.delete-checkbox input:checked');
      if (!checked.length) return alert('å‰Šé™¤ã™ã‚‹åœ¨åº«ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
      if (!confirm('é¸æŠã•ã‚ŒãŸåœ¨åº«ã‚’Firebaseã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      for (const cb of checked) {
        await remove(ref(db, `inventory/${cb.value}`));
      }
      alert("å‰Šé™¤ã—ã¾ã—ãŸï¼");
      location.reload();
    }

    async function loadInventory() {
      const inventorySnap = await get(ref(db, 'inventory'));
      const usedSnap = await get(ref(db, 'usedReports'));

      const inventory = inventorySnap.val() || {};
      const used = usedSnap.val() || {};

      const usedMap = {};
      const usedCodes = new Set();

      Object.values(used).forEach(item => {
        if (!usedMap[item.itemId]) usedMap[item.itemId] = 0;
        usedMap[item.itemId] += Number(item.quantity);
        usedCodes.add(item.manageCode);
      });

      const items = Object.entries(inventory).map(([id, item]) => {
        const remaining = item.quantity - (usedMap[id] || 0);
        return remaining > 0 ? { ...item, id, remaining } : null;
      }).filter(Boolean);

      renderInventory(items, usedCodes);
    }

    function renderInventory(items, usedCodes) {
      const grouped = {};
      const container = document.getElementById('inventoryContainer');
      container.innerHTML = '';

      items.forEach(item => {
        const cat = item.category || 'æœªåˆ†é¡';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(item);
      });

      const categories = Object.keys(grouped);
      const categoryOptions = ["", "ã‚¬ã‚¹çµ¦æ¹¯å™¨", "ã‚¬ã‚¹ç¬é–“æ¹¯æ²¸å™¨", "ãƒªãƒ¢ã‚³ãƒ³", "é…ç®¡ã‚«ãƒãƒ¼"];

      categories.forEach(cat => {
        const h2 = document.createElement('h2');
        h2.textContent = `ğŸ“ ${cat}`;
        container.appendChild(h2);

        const wrapper = document.createElement("div");
        wrapper.className = "table-wrapper";
        const table = document.createElement("table");

        const prefix = cat.includes('çµ¦æ¹¯') ? 'ã‚­-' : cat.includes('æ¹¯æ²¸') ? 'ãƒ¦-' : cat.includes('ãƒªãƒ¢ã‚³ãƒ³') ? 'ãƒª-' : '-';

        table.innerHTML = `
          <thead><tr>
            <th>ç™»éŒ²è€…</th><th>ã‚«ãƒ†ã‚´ãƒªï¼†ç¾å ´å</th><th>å•†å“å</th><th>å‹å¼</th><th>æ®‹æ•°</th><th>ä»•å…¥ã‚Œæ—¥</th><th>æ“ä½œ</th>
          </tr></thead>
          <tbody>
            ${grouped[cat].map(item => {
              const catSel = categoryOptions.map(opt => `<option value="${opt}" ${opt === item.category ? 'selected' : ''}>${opt}</option>`).join('');
              const qtySel = Array.from({length: item.remaining}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('');
              return `
              <tr>
                <td>${item.user}</td>
                <td>
                  <div class="input-group">
                    <select onchange="updateCategory('${item.id}', this.value)">${catSel}</select>
                    <input type="text" value="${item.site || ''}" onchange="updateSite('${item.id}', this.value)">
                  </div>
                </td>
                <td>${item.name}</td>
                <td>${item.model}</td>
                <td>${item.remaining}</td>
                <td>${item.date}</td>
                <td>
                  <div class="select-group">
                    <select id="user-${item.id}"><option value="">ä½¿ç”¨è€…é¸æŠ</option><option>é˜¿éƒ¨</option><option>éˆ´æœ¨</option><option>ç´ºé‡</option><option>äº€å²¡</option><option>å¤§æ§»</option><option>é’ç”°</option><option>èŠç”°</option><option>é«˜æ©‹</option><option>ä½è—¤</option><option>ä»Šæ³‰</option></select>
                    <select id="qty-${item.id}">${qtySel}</select>
                    <input type="text" id="code-${item.id}" placeholder="${prefix}ç•ªå·">
                    <button class="unused" onclick="useItem('${item.id}', '${prefix}', ${JSON.stringify(Array.from(usedCodes))})">ä½¿ç”¨ã™ã‚‹</button>
                    <span class="delete-checkbox" style="display:none"><input type="checkbox" value="${item.id}"></span>
                  </div>
                </td>
              </tr>`;
            }).join('')}
          </tbody>`;
        wrapper.appendChild(table);
        container.appendChild(wrapper);
      });
    }

    window.updateCategory = async (id, value) => {
      await update(ref(db, `inventory/${id}`), { category: value });
    }

    window.updateSite = async (id, value) => {
      await update(ref(db, `inventory/${id}`), { site: value });
    }

    window.useItem = async (id, prefix, usedCodes) => {
      const user = document.getElementById(`user-${id}`).value;
      const qty = parseInt(document.getElementById(`qty-${id}`).value);
      const code = document.getElementById(`code-${id}`).value.trim();
      if (!user || !qty || !code) return alert('å…¨é …ç›®ã‚’å…¥åŠ›ã—ã¦ã­');
      const fullCode = prefix + code;
      if (usedCodes.includes(fullCode)) return alert('ãã®ç®¡ç†ç•ªå·ã¯ã™ã§ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ï¼');

      const snap = await get(ref(db, `inventory/${id}`));
      if (!snap.exists()) return alert("åœ¨åº«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      const item = snap.val();

      await push(ref(db, "usedReports"), {
        itemId: id,
        itemName: item.name,
        model: item.model,
        user,
        quantity: qty,
        manageCode: fullCode,
        date: new Date().toLocaleString()
      });

      alert(`ã€Œ${item.name}ã€ã‚’ ${qty} å€‹ï¼ˆ${fullCode}ï¼‰ã€${user} ã•ã‚“ãŒä½¿ç”¨ã—ã¾ã—ãŸï¼`);
      location.reload();
    }

    loadInventory();
  </script>
</body>
</html>
